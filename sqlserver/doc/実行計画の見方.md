# 実行計画の見方

## テーブルアクセスの種類

- Table Scan
  - インデックスを使用せず、ヒープにあるデータへのアクセス
  - クラスタ化インデックスが張られていないテーブルに対して「Where条件無しか、インデックスが張られていないカラムを条件に」抽出を行う場合に発生

- Index Seek
  - インデックスに対する二分探索を行うテーブルアクセス
  - 検索条件にインデックスが貼られたカラムを指定するとこれになり、データを全件走査するのではなくインデックスに対して二分木探索を行うので高速

- Index Scan (NonClustered)
  - 「インデックスに対して全件走査を掛ける」
  - インデックスが貼られたカラムのみをSelectで出力したりすると発生

- Clustered Index Scan
  - 上記の「Index Scan」は、(NonClustered)と書かれている通り、あちらは「非クラスタ化インデックス」に対してのアクション
  - クラスタ化インデックスを使用はしていますが、実際は全てのデータに対して走査をかけているので、性能は「Table Scan」に近く低速
  - クラスタ化インデックスが張られているテーブルに対して「Where条件無しか、インデックスが張られていないカラムを条件に」抽出を行う場合に発生

- Clustered Index Seek
  - クラスタ化インデックスに対して二分木探索を行いますので、Index Scanと同様に高速
  - クラスタ化インデックスカラムに対しての条件指定での抽出を行うと発生

## 結合の種類

- Nested Loops
  - ２つのテーブルを二重ループで結合するもの
  - 基本的にはこれが使用される

- Hash Match
  - 結合キーに対してハッシュ関数を使用してハッシュテーブルを作成し、相手のテーブルの結合キーにハッシュ値が存在するかを調べる
  - Nested Loopsが有効でない場合に選択されることがありますが、メモリを多く消費するのでパフォーマンスが落ちる可能性あり

- Merge Join
  - 結合キーによって結合対象テーブルをソートし、キーに含まれていたら結果セットに対象行を含める

## キー参照の種類

Where句にインデックス対象行が指定され、Select句にインデックス以外のカラムが指定された場合、Index Seekによる二分木探索が行われた後に足りないデータを探しにキー参照が行われる

クラスタ化インデックスが張られているかによって以下の二種類のどちらかが実行され、インデックスで取得したデータに結合される。

Index Seekが行われているのに遅い原因の一つになり得、インデックス以外の列が不要であればSelect句から外すなどでこのキー参照を行わないようにすることが可能。

- RID Lookup
  - クラスタ化インデックスが張られていないテーブルに対して使われるキー参照
  - インデックスのリーフノードに格納された、データを一意に識別するための「RID」によりヒープ領域(テーブルの実データが格納されている)に対象行のデータを取得

- キー参照(Clustered)
  - クラスタ化インデックスが張られているテーブルに対して使われるキー参照
  - クラスタ化インデックスを使用して対象行のデータを取得しにいく

## 述語の種類

ここではインデックスが正常に使用されているかを判断する一つの要素として、プロパティの述語について記載

実行プラン取得時、Index Seekだけでなく、Where句や結合が行われた場合テーブルアクセスのアクションのプロパティに条件での「述語」もしくは「シーク述語」が表示されており、「述語」に条件が表記されていれば、チューニングの余地がある


## 統計情報との関係

実行計画を作る時にオプティマイザがデータ分布の参考として用いるのが統計情報で、統計情報が古いとSQLのパフォーマンスが落ちるのは、過去のデータ分布に対して最適な実行計画が今のデータ分布には最適でないことがあるため。

統計情報のデータ分布が古いと、インデックスが使用されなかったり効率の悪いインデックスが使用されてり、パフォーマンスの悪い結合が行われることがある。

パフォーマンスが悪いSQLを発行してしまっている場合はもちろん、上記のような統計情報が古いことにより最適化が正常に行われていないことを検知するためにも、実行計画を読み解くことは有用な手段。




## 参考URL

- [【SQL Server】実行計画を見てみよう](https://www.w2solution.co.jp/tech/2020/10/26/%E3%80%90sql-server%E3%80%91%E5%AE%9F%E8%A1%8C%E8%A8%88%E7%94%BB%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86/)
